const f=document.getElementById("game-wrapper"),F=document.getElementById("menu-screen"),z=document.getElementById("game-screen"),K=document.getElementById("level-complete-screen"),J=document.getElementById("mini-game-screen"),Q=document.getElementById("game-over-screen"),G=document.getElementById("menu-high-score"),ee=document.getElementById("start-btn"),te=document.getElementById("level-display"),ne=document.getElementById("rank-display"),oe=document.getElementById("poo-counter"),se=document.getElementById("score-display"),H=document.getElementById("timer-display"),I=document.getElementById("game-grid"),N=document.getElementById("streak-display"),W=document.getElementById("next-level-btn"),X=document.getElementById("restart-btn"),i={level:f.dataset.tLevel||"Level",score:f.dataset.tScore||"Score",levelComplete:f.dataset.tLevelComplete||"Case Closed!",accuracy:f.dataset.tAccuracy||"Accuracy",timeBonus:f.dataset.tTimeBonus||"Time Bonus",nextLevel:f.dataset.tNextLevel||"Next Case",gameOver:f.dataset.tGameOver||"Investigation Over!",totalPoos:f.dataset.tTotalPoos||"Poos Found",playAgain:f.dataset.tPlayAgain||"New Investigation",bonusRound:f.dataset.tBonusRound||"BONUS ROUND!",highScore:f.dataset.tHighScore||"High Score",miniPoo:f.dataset.tMiniPoo||"POO!",miniNot:f.dataset.tMiniNot||"NOT POO!"},D=[["üå≥","üå≤","üåø","üå∫","üåª","ü™®","üçÑ","ü™¥","üåµ","üéã","üåæ","üçÄ"],["üç≥","ü•ò","üç≤","üßÅ","üéÇ","üç©","ü•ß","üç™","üç∞","üßá","ü•û","üçï"],["üêö","ü¶Ä","ü™∏","‚õ±Ô∏è","üßä","ü™£","üê†","ü¶ê","üê°","ü™º","üê¢","ü¶ë"],["üè¢","üöó","üóëÔ∏è","üì´","üöß","üß±","üè†","üö≤","ü™ë","üì¶","üõí","üöå"],["ü¶ä","üêøÔ∏è","ü¶â","üêª","ü¶å","üê∫","üêá","üçÇ","üçÅ","ü™µ","üå≤","üêõ"],["üöÄ","üõ∏","‚≠ê","üåô","‚òÑÔ∏è","ü™ê","üëæ","ü§ñ","üõ∞Ô∏è","üåç","üî≠","üí´"],["üé∏","üéπ","üé∫","ü•Å","üéª","üé∑","üé§","üéµ","üé∂","üìª","üéß","ü™ò"],["üèÄ","‚öΩ","üéæ","üèà","üèê","üé±","üèì","ü•ä","üèãÔ∏è","‚õ∑Ô∏è","üèÑ","üö¥"]],U=[{threshold:0,name:"Rookie",emoji:"üî∞"},{threshold:500,name:"Tracker",emoji:"üëÉ"},{threshold:1500,name:"Sniffer",emoji:"üêï"},{threshold:3e3,name:"Inspector",emoji:"üïµÔ∏è"},{threshold:6e3,name:"Master",emoji:"üéñÔ∏è"},{threshold:1e4,name:"Legend",emoji:"üëë"}],j=["üí©","üç´","üç©","üßÅ","üçÆ","üå∞","ü•ú","üç†","ü™µ","üçÇ","üêª","üèà","ü•î","ü´ò","üßÜ"],q=j.slice(1),le=100,ce=5,ae=10;let p=1,h=0,L=0,E=0,T=0,k=0,x=0,_=[],O=4,v=0,B=null,C=(()=>{try{return Number(localStorage.getItem("poo-land-high-score"))||0}catch{return 0}})(),w=!1;G.textContent=C.toString();function ie(e){const o=Math.min(4+Math.floor((e-1)/3),8),t=Math.min(2+Math.floor(e/2),Math.floor(o*o*.25)),c=Math.max(20,60-(e-1)*3);return{gridSize:o,numPoos:Math.max(2,t),timeLimit:c}}function re(e,o){const t=e*e,c=D[Math.floor(Math.random()*D.length)],l=new Set;for(;l.size<o;)l.add(Math.floor(Math.random()*t));const n=[];for(let s=0;s<t;s++)n.push({isPoo:l.has(s),emoji:c[Math.floor(Math.random()*c.length)],adjacentPoos:0,revealed:!1});for(let s=0;s<t;s++){if(n[s].isPoo)continue;const u=Math.floor(s/e),g=s%e;let y=0;for(let r=-1;r<=1;r++)for(let a=-1;a<=1;a++){if(r===0&&a===0)continue;const m=u+r,d=g+a;m>=0&&m<e&&d>=0&&d<e&&n[m*e+d].isPoo&&y++}n[s].adjacentPoos=y}return n}function S(e){[F,z,K,J,Q].forEach(o=>{o.style.display="none"}),e.style.display="flex"}function me(e){let o=U[0];for(const t of U)e>=t.threshold&&(o=t);return o}function A(){I.innerHTML="",I.style.gridTemplateColumns=`repeat(${O}, minmax(0, 1fr))`,_.forEach((e,o)=>{const t=document.createElement("button");t.className="tile",t.dataset.index=o.toString(),t.setAttribute("aria-label",`Tile ${o+1}`),e.revealed?e.isPoo?(t.textContent="üí©",t.classList.add("tile-found")):(t.textContent=e.adjacentPoos>0?e.adjacentPoos.toString():"",t.classList.add("tile-searched"),e.adjacentPoos>=3?t.classList.add("tile-hot"):e.adjacentPoos>=1?t.classList.add("tile-warm"):t.classList.add("tile-cold")):(t.textContent=e.emoji,t.classList.add("tile-hidden")),I.appendChild(t)})}I.addEventListener("click",e=>{const o=e.target.closest(".tile");o?.dataset.index&&de(Number(o.dataset.index))});function b(){te.textContent=`${i.level} ${p}`;const e=me(h);ne.textContent=`${e.emoji} ${e.name}`,oe.textContent=`üí© ${E}/${k}`,se.textContent=`${i.score}: ${h}`,H.textContent=`‚è±Ô∏è ${x}`,v>=2?(N.textContent=`üî• x${v}`,N.style.display="inline"):N.style.display="none"}function de(e){const o=_[e];if(!o.revealed){if(o.revealed=!0,T++,o.isPoo){E++,L++,v++;const t=Math.min(v,ce),c=le*p*t;if(h+=c,ue(e,`+${c}`,"#22c55e"),E>=k){R();const l=x*ae;h+=l,A(),b();const n=Math.floor((L-E)/10);w=Math.floor(L/10)>n,setTimeout(()=>ge(l),600);return}}else v=0;A(),b()}}function ue(e,o,t){const l=I.querySelectorAll(".tile")[e];if(!l)return;const n=document.createElement("span");n.className="float-text",n.textContent=o,n.style.color=t,l.appendChild(n),setTimeout(()=>n.remove(),800)}function fe(){R(),B=setInterval(()=>{x--,b(),x<=10&&H.classList.add("timer-danger"),x<=0&&(R(),pe())},1e3)}function R(){B&&(clearInterval(B),B=null),H.classList.remove("timer-danger")}function he(){p=1,h=0,L=0,v=0,P()}function P(){const e=ie(p);O=e.gridSize,k=e.numPoos,x=e.timeLimit,E=0,T=0,v=0,_=re(O,k),S(z),A(),b(),fe()}function ge(e){const o=document.getElementById("level-complete-title"),t=document.getElementById("lc-accuracy-label"),c=document.getElementById("lc-accuracy"),l=document.getElementById("lc-time-label"),n=document.getElementById("lc-time"),s=document.getElementById("lc-score-label"),u=document.getElementById("lc-score");o.textContent=`${i.levelComplete} ${i.level} ${p}`;const g=T>0?Math.round(E/T*100):100;t.textContent=i.accuracy,c.textContent=`${g}%`,l.textContent=i.timeBonus,n.textContent=`+${e}`,s.textContent=i.score,u.textContent=h.toString(),W.textContent=w?`üé∞ ${i.bonusRound}`:i.nextLevel,Y(),S(K)}function pe(){const e=document.getElementById("game-over-title"),o=document.getElementById("go-level-label"),t=document.getElementById("go-level"),c=document.getElementById("go-poos-label"),l=document.getElementById("go-poos"),n=document.getElementById("go-score-label"),s=document.getElementById("go-score");e.textContent=i.gameOver,o.textContent=i.level,t.textContent=p.toString(),c.textContent=i.totalPoos,l.textContent=L.toString(),n.textContent=i.score,s.textContent=h.toString(),X.textContent=i.playAgain,Y(),S(Q)}function Y(){if(h>C){C=h;try{localStorage.setItem("poo-land-high-score",C.toString())}catch{}G.textContent=C.toString()}}function ye(){w=!1;const e=["whack","quicksniff"],o=e[Math.floor(Math.random()*e.length)],t=document.getElementById("mini-game-title"),c=document.getElementById("mini-game-area"),l=document.getElementById("mini-score"),n=document.getElementById("mini-timer");t.textContent=i.bonusRound,c.innerHTML="",S(J);const s=15;l.textContent=`${i.score}: 0`,n.textContent=`‚è±Ô∏è ${s}`,o==="whack"?ve(c,l,n,s,u=>{h+=u,p++,P()}):Ce(c,l,n,s,u=>{h+=u,p++,P()})}function ve(e,o,t,c,l){let n=0,s=c;e.innerHTML="",e.className="mini-game-area whack-grid";const u=[];for(let r=0;r<9;r++){const a=document.createElement("div");a.className="whack-hole";const m=document.createElement("span");m.className="whack-mole",m.textContent="",a.appendChild(m),e.appendChild(a),u.push(a),a.addEventListener("click",()=>{const d=a.querySelector(".whack-mole");d.textContent&&(d.textContent==="üí©"?(n+=100,a.classList.add("whack-hit")):(n=Math.max(0,n-50),a.classList.add("whack-miss")),d.textContent="",d.classList.remove("whack-up"),o.textContent=`${i.score}: ${n}`,setTimeout(()=>{a.classList.remove("whack-hit","whack-miss")},300))})}const g=setInterval(()=>{const r=u.filter(M=>!M.querySelector(".whack-mole").textContent);if(r.length===0)return;const m=r[Math.floor(Math.random()*r.length)].querySelector(".whack-mole"),d=Math.random()<.65;m.textContent=d?"üí©":j[Math.floor(Math.random()*(j.length-1))+1],m.classList.add("whack-up"),setTimeout(()=>{m.textContent="",m.classList.remove("whack-up")},1200)},700),y=setInterval(()=>{s--,t.textContent=`‚è±Ô∏è ${s}`,s<=0&&(clearInterval(y),clearInterval(g),setTimeout(()=>l(n),500))},1e3)}function Ce(e,o,t,c,l){let n=0,s=c,u="",g=!1,y=!1;e.innerHTML="",e.className="mini-game-area sniff-area";const r=document.createElement("div");r.className="sniff-emoji",e.appendChild(r);const a=document.createElement("div");a.className="sniff-buttons";const m=document.createElement("button");m.className="btn btn-primary sniff-btn sniff-yes",m.textContent=`üí© ${i.miniPoo}`,a.appendChild(m);const d=document.createElement("button");d.className="btn btn-outline sniff-btn sniff-no",d.textContent=`‚ùå ${i.miniNot}`,a.appendChild(d),e.appendChild(a);function M(){y=!1,g=Math.random()<.4,g?u="üí©":u=q[Math.floor(Math.random()*q.length)],r.textContent=u,r.className="sniff-emoji sniff-appear"}function $(Z){if(y)return;y=!0,Z===g?(n+=100,r.classList.add("sniff-correct")):(n=Math.max(0,n-50),r.classList.add("sniff-wrong")),o.textContent=`${i.score}: ${n}`,setTimeout(M,600)}m.addEventListener("click",()=>$(!0)),d.addEventListener("click",()=>$(!1)),M();const V=setInterval(()=>{s--,t.textContent=`‚è±Ô∏è ${s}`,s<=0&&(clearInterval(V),m.disabled=!0,d.disabled=!0,setTimeout(()=>l(n),500))},1e3)}ee.addEventListener("click",he);X.addEventListener("click",()=>{S(F),G.textContent=C.toString()});W.addEventListener("click",()=>{w?ye():(p++,P())});
