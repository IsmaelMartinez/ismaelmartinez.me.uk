---
import Layout from '../../../layouts/Layout.astro';
import ArticleCard from '../../../components/ArticleCard.astro';
import { useTranslations, locales } from '../../../i18n/translations';
import type { Locale } from '../../../i18n/translations';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allArticles = await getCollection('articles', ({ data }) => {
    return import.meta.env.DEV || !data.draft;
  });

  return locales.flatMap(lang => {
    const localeArticles = allArticles.filter(a => a.slug.startsWith(`${lang}/`));
    const tags = new Set<string>();
    for (const article of localeArticles) {
      for (const tag of article.data.tags) {
        tags.add(tag);
      }
    }

    return [...tags].map(tag => ({
      params: { lang, tag },
      props: {
        tag,
        articles: localeArticles
          .filter(a => a.data.tags.includes(tag))
          .sort((a, b) => b.data.publishedDate.valueOf() - a.data.publishedDate.valueOf()),
      },
    }));
  });
}

const lang = Astro.params.lang as Locale;
const t = useTranslations(lang);
const { tag, articles } = Astro.props;
---

<Layout title={`${t('tags.articlesTagged')} "${tag}"`} lang={lang}>
  <section class="section">
    <div class="container">
      <header class="page-header">
        <h1 class="page-title">{t('tags.articlesTagged')} "{tag}"</h1>
        <p class="page-description">{articles.length} {articles.length === 1 ? t('tags.article') : t('tags.articles')}</p>
      </header>

      <div class="articles-grid">
        {articles.map(article => (
          <ArticleCard
            title={article.data.title}
            description={article.data.description}
            publishedDate={article.data.publishedDate}
            slug={article.slug.replace(`${lang}/`, '')}
            tags={article.data.tags}
            lang={lang}
            originalPlatform={article.data.originalPlatform}
          />
        ))}
      </div>
    </div>
  </section>
</Layout>

<style>
  .page-header {
    margin-bottom: var(--space-2xl);
  }

  .page-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: var(--space-md);
  }

  .page-description {
    font-size: 1.125rem;
    color: var(--color-text-muted);
  }

  .articles-grid {
    display: grid;
    gap: var(--space-lg);
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }
</style>
