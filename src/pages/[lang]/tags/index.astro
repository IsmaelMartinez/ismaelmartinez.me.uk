---
import Layout from '../../../layouts/Layout.astro';
import { useTranslations, getLocalizedPath, locales } from '../../../i18n/translations';
import type { Locale } from '../../../i18n/translations';
import { getCollection } from 'astro:content';

export function getStaticPaths() {
  return locales.map(lang => ({ params: { lang } }));
}

const lang = Astro.params.lang as Locale;
const t = useTranslations(lang);

const articles = await getCollection('articles', ({ slug, data }) => {
  return slug.startsWith(`${lang}/`) && (import.meta.env.DEV || !data.draft);
});

const tagCounts = new Map<string, number>();
for (const article of articles) {
  for (const tag of article.data.tags) {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  }
}

const sortedTags = [...tagCounts.entries()].sort((a, b) => b[1] - a[1]);
---

<Layout title={t('tags.title')} description={t('tags.description')} lang={lang}>
  <section class="section">
    <div class="container">
      <header class="page-header">
        <h1 class="page-title">{t('tags.title')}</h1>
        <p class="page-description">{t('tags.description')}</p>
      </header>

      <div class="tags-grid">
        {sortedTags.map(([tag, count]) => (
          <a href={getLocalizedPath(`/tags/${encodeURIComponent(tag)}`, lang)} class="tag-card">
            <span class="tag-name">{tag}</span>
            <span class="tag-count">{count} {count === 1 ? t('tags.article') : t('tags.articles')}</span>
          </a>
        ))}
      </div>
    </div>
  </section>
</Layout>

<style>
  .page-header {
    margin-bottom: var(--space-2xl);
  }

  .page-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: var(--space-md);
  }

  .page-description {
    font-size: 1.125rem;
    color: var(--color-text-muted);
    max-width: 600px;
  }

  .tags-grid {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-md);
  }

  .tag-card {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    padding: var(--space-md) var(--space-lg);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 0.75rem;
    text-decoration: none;
    transition: border-color 0.2s ease;
  }

  .tag-card:hover {
    border-color: var(--color-accent);
  }

  .tag-name {
    font-weight: 600;
    color: var(--color-text);
  }

  .tag-count {
    font-size: 0.8rem;
    color: var(--color-text-muted);
  }
</style>
