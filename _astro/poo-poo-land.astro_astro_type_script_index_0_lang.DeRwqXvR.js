const f=document.getElementById("game-wrapper"),W=document.getElementById("menu-screen"),J=document.getElementById("game-screen"),Q=document.getElementById("level-complete-screen"),X=document.getElementById("mini-game-screen"),Y=document.getElementById("game-over-screen"),H=document.getElementById("menu-high-score"),oe=document.getElementById("start-btn"),se=document.getElementById("level-display"),le=document.getElementById("rank-display"),ce=document.getElementById("poo-counter"),ae=document.getElementById("score-display"),D=document.getElementById("timer-display"),x=document.getElementById("game-grid"),j=document.getElementById("streak-display"),V=document.getElementById("next-level-btn"),Z=document.getElementById("restart-btn"),A=document.getElementById("powerup-btn"),ie=document.getElementById("powerup-count"),i={level:f.dataset.tLevel||"Level",score:f.dataset.tScore||"Score",levelComplete:f.dataset.tLevelComplete||"Case Closed!",accuracy:f.dataset.tAccuracy||"Accuracy",timeBonus:f.dataset.tTimeBonus||"Time Bonus",nextLevel:f.dataset.tNextLevel||"Next Case",gameOver:f.dataset.tGameOver||"Investigation Over!",totalPoos:f.dataset.tTotalPoos||"Poos Found",playAgain:f.dataset.tPlayAgain||"New Investigation",bonusRound:f.dataset.tBonusRound||"BONUS ROUND!",highScore:f.dataset.tHighScore||"High Score",miniPoo:f.dataset.tMiniPoo||"POO!",miniNot:f.dataset.tMiniNot||"NOT POO!",powerUp:f.dataset.tPowerUp||"Sniff"},F=[["üå≥","üå≤","üåø","üå∫","üåª","ü™®","üçÑ","ü™¥","üåµ","üéã","üåæ","üçÄ"],["üç≥","ü•ò","üç≤","üßÅ","üéÇ","üç©","ü•ß","üç™","üç∞","üßá","ü•û","üçï"],["üêö","ü¶Ä","ü™∏","‚õ±Ô∏è","üßä","ü™£","üê†","ü¶ê","üê°","ü™º","üê¢","ü¶ë"],["üè¢","üöó","üóëÔ∏è","üì´","üöß","üß±","üè†","üö≤","ü™ë","üì¶","üõí","üöå"],["ü¶ä","üêøÔ∏è","ü¶â","üêª","ü¶å","üê∫","üêá","üçÇ","üçÅ","ü™µ","üå≤","üêõ"],["üöÄ","üõ∏","‚≠ê","üåô","‚òÑÔ∏è","ü™ê","üëæ","ü§ñ","üõ∞Ô∏è","üåç","üî≠","üí´"],["üé∏","üéπ","üé∫","ü•Å","üéª","üé∑","üé§","üéµ","üé∂","üìª","üéß","ü™ò"],["üèÄ","‚öΩ","üéæ","üèà","üèê","üé±","üèì","ü•ä","üèãÔ∏è","‚õ∑Ô∏è","üèÑ","üö¥"]],z=[{threshold:0,name:"Rookie",emoji:"üî∞"},{threshold:500,name:"Tracker",emoji:"üëÉ"},{threshold:1500,name:"Sniffer",emoji:"üêï"},{threshold:3e3,name:"Inspector",emoji:"üïµÔ∏è"},{threshold:6e3,name:"Master",emoji:"üéñÔ∏è"},{threshold:1e4,name:"Legend",emoji:"üëë"}],R=["üí©","üç´","üç©","üßÅ","üçÆ","üå∞","ü•ú","üç†","ü™µ","üçÇ","üêª","üèà","ü•î","ü´ò","üßÜ"],K=R.slice(1),re=100,me=5,de=10,ue=2,fe=1500;let p=1,h=0,S=0,I=0,w=0,P=0,L=0,N=[],U=4,E=0,C=0,T=null,v=(()=>{try{return Number(localStorage.getItem("poo-land-high-score"))||0}catch{return 0}})(),$=!1;H.textContent=v.toString();function he(e){const o=Math.min(4+Math.floor((e-1)/3),8),t=Math.min(2+Math.floor(e/2),Math.floor(o*o*.25)),c=Math.max(20,60-(e-1)*3);return{gridSize:o,numPoos:Math.max(2,t),timeLimit:c}}function ge(e,o){const t=e*e,c=F[Math.floor(Math.random()*F.length)],s=new Set;for(;s.size<o;)s.add(Math.floor(Math.random()*t));const n=[];for(let l=0;l<t;l++)n.push({isPoo:s.has(l),emoji:c[Math.floor(Math.random()*c.length)],adjacentPoos:0,revealed:!1});for(let l=0;l<t;l++){if(n[l].isPoo)continue;const u=Math.floor(l/e),g=l%e;let y=0;for(let r=-1;r<=1;r++)for(let a=-1;a<=1;a++){if(r===0&&a===0)continue;const m=u+r,d=g+a;m>=0&&m<e&&d>=0&&d<e&&n[m*e+d].isPoo&&y++}n[l].adjacentPoos=y}return n}function M(e){[W,J,Q,X,Y].forEach(o=>{o.style.display="none"}),e.style.display="flex"}function pe(e){let o=z[0];for(const t of z)e>=t.threshold&&(o=t);return o}function _(){x.innerHTML="",x.style.gridTemplateColumns=`repeat(${U}, minmax(0, 1fr))`,N.forEach((e,o)=>{const t=document.createElement("button");t.className="tile",t.dataset.index=o.toString(),t.setAttribute("aria-label",`Tile ${o+1}`),e.revealed?e.isPoo?(t.textContent="üí©",t.classList.add("tile-found")):(t.textContent=e.adjacentPoos>0?e.adjacentPoos.toString():"",t.classList.add("tile-searched"),e.adjacentPoos>=3?t.classList.add("tile-hot"):e.adjacentPoos>=1?t.classList.add("tile-warm"):t.classList.add("tile-cold")):(t.textContent=e.emoji,t.classList.add("tile-hidden")),x.appendChild(t)})}x.addEventListener("click",e=>{const o=e.target.closest(".tile");o?.dataset.index&&Ee(Number(o.dataset.index))});function b(){se.textContent=`${i.level} ${p}`;const e=pe(h);le.textContent=`${e.emoji} ${e.name}`,ce.textContent=`üí© ${I}/${P}`,ae.textContent=`${i.score}: ${h}`,D.textContent=`‚è±Ô∏è ${L}`,E>=2?(j.textContent=`üî• x${E}`,j.style.display="inline"):j.style.display="none"}function q(){ie.textContent=C.toString(),A.disabled=C<=0,A.classList.toggle("powerup-available",C>0)}function ye(){if(C<=0)return;const e=N.map((s,n)=>({cell:s,i:n})).filter(({cell:s})=>s.isPoo&&!s.revealed);if(e.length===0)return;C--,q();const o=e[Math.floor(Math.random()*e.length)],c=x.querySelectorAll(".tile")[o.i];if(c){const s=c.textContent||"";c.textContent="üí©",c.classList.add("tile-hint"),setTimeout(()=>{c.textContent=s,c.classList.remove("tile-hint")},fe)}}A.addEventListener("click",ye);function Ee(e){const o=N[e];if(!o.revealed){if(o.revealed=!0,w++,o.isPoo){I++,S++,E++;const t=Math.min(E,me),c=re*p*t;h+=c;let s=`+${c}`;if(E>=ue&&(C++,q(),s+=" üêï+1"),Ce(e,s,"#22c55e"),I>=P){G();const n=L*de;h+=n,_(),b();const l=Math.floor((S-I)/10);$=Math.floor(S/10)>l,setTimeout(()=>Ie(n),600);return}}else E=0;_(),b()}}function Ce(e,o,t){const s=x.querySelectorAll(".tile")[e];if(!s)return;const n=document.createElement("span");n.className="float-text",n.textContent=o,n.style.color=t,s.appendChild(n),setTimeout(()=>n.remove(),800)}function ve(){G(),T=setInterval(()=>{L--,b(),L<=10&&D.classList.add("timer-danger"),L<=0&&(G(),Le())},1e3)}function G(){T&&(clearInterval(T),T=null),D.classList.remove("timer-danger")}function xe(){p=1,h=0,S=0,E=0,C=0,q(),k()}function k(){const e=he(p);U=e.gridSize,P=e.numPoos,L=e.timeLimit,I=0,w=0,E=0,N=ge(U,P),M(J),_(),b(),ve()}function Ie(e){const o=document.getElementById("level-complete-title"),t=document.getElementById("lc-accuracy-label"),c=document.getElementById("lc-accuracy"),s=document.getElementById("lc-time-label"),n=document.getElementById("lc-time"),l=document.getElementById("lc-score-label"),u=document.getElementById("lc-score");o.textContent=`${i.levelComplete} ${i.level} ${p}`;const g=w>0?Math.round(I/w*100):100;t.textContent=i.accuracy,c.textContent=`${g}%`,s.textContent=i.timeBonus,n.textContent=`+${e}`,l.textContent=i.score,u.textContent=h.toString(),V.textContent=$?`üé∞ ${i.bonusRound}`:i.nextLevel,ee(),M(Q)}function Le(){const e=document.getElementById("game-over-title"),o=document.getElementById("go-level-label"),t=document.getElementById("go-level"),c=document.getElementById("go-poos-label"),s=document.getElementById("go-poos"),n=document.getElementById("go-score-label"),l=document.getElementById("go-score");e.textContent=i.gameOver,o.textContent=i.level,t.textContent=p.toString(),c.textContent=i.totalPoos,s.textContent=S.toString(),n.textContent=i.score,l.textContent=h.toString(),Z.textContent=i.playAgain,ee(),M(Y)}function ee(){if(h>v){v=h;try{localStorage.setItem("poo-land-high-score",v.toString())}catch{}H.textContent=v.toString()}}function Se(){$=!1;const e=["whack","quicksniff"],o=e[Math.floor(Math.random()*e.length)],t=document.getElementById("mini-game-title"),c=document.getElementById("mini-game-area"),s=document.getElementById("mini-score"),n=document.getElementById("mini-timer");t.textContent=i.bonusRound,c.innerHTML="",M(X);const l=15;s.textContent=`${i.score}: 0`,n.textContent=`‚è±Ô∏è ${l}`,o==="whack"?Me(c,s,n,l,u=>{h+=u,p++,k()}):Be(c,s,n,l,u=>{h+=u,p++,k()})}function Me(e,o,t,c,s){let n=0,l=c;e.innerHTML="",e.className="mini-game-area whack-grid";const u=[];for(let r=0;r<9;r++){const a=document.createElement("div");a.className="whack-hole";const m=document.createElement("span");m.className="whack-mole",m.textContent="",a.appendChild(m),e.appendChild(a),u.push(a),a.addEventListener("click",()=>{const d=a.querySelector(".whack-mole");d.textContent&&(d.textContent==="üí©"?(n+=100,a.classList.add("whack-hit")):(n=Math.max(0,n-50),a.classList.add("whack-miss")),d.textContent="",d.classList.remove("whack-up"),o.textContent=`${i.score}: ${n}`,setTimeout(()=>{a.classList.remove("whack-hit","whack-miss")},300))})}const g=setInterval(()=>{const r=u.filter(B=>!B.querySelector(".whack-mole").textContent);if(r.length===0)return;const m=r[Math.floor(Math.random()*r.length)].querySelector(".whack-mole"),d=Math.random()<.65;m.textContent=d?"üí©":R[Math.floor(Math.random()*(R.length-1))+1],m.classList.add("whack-up"),setTimeout(()=>{m.textContent="",m.classList.remove("whack-up")},1200)},700),y=setInterval(()=>{l--,t.textContent=`‚è±Ô∏è ${l}`,l<=0&&(clearInterval(y),clearInterval(g),setTimeout(()=>s(n),500))},1e3)}function Be(e,o,t,c,s){let n=0,l=c,u="",g=!1,y=!1;e.innerHTML="",e.className="mini-game-area sniff-area";const r=document.createElement("div");r.className="sniff-emoji",e.appendChild(r);const a=document.createElement("div");a.className="sniff-buttons";const m=document.createElement("button");m.className="btn btn-primary sniff-btn sniff-yes",m.textContent=`üí© ${i.miniPoo}`,a.appendChild(m);const d=document.createElement("button");d.className="btn btn-outline sniff-btn sniff-no",d.textContent=`‚ùå ${i.miniNot}`,a.appendChild(d),e.appendChild(a);function B(){y=!1,g=Math.random()<.4,g?u="üí©":u=K[Math.floor(Math.random()*K.length)],r.textContent=u,r.className="sniff-emoji sniff-appear"}function O(ne){if(y)return;y=!0,ne===g?(n+=100,r.classList.add("sniff-correct")):(n=Math.max(0,n-50),r.classList.add("sniff-wrong")),o.textContent=`${i.score}: ${n}`,setTimeout(B,600)}m.addEventListener("click",()=>O(!0)),d.addEventListener("click",()=>O(!1)),B();const te=setInterval(()=>{l--,t.textContent=`‚è±Ô∏è ${l}`,l<=0&&(clearInterval(te),m.disabled=!0,d.disabled=!0,setTimeout(()=>s(n),500))},1e3)}oe.addEventListener("click",xe);Z.addEventListener("click",()=>{M(W),H.textContent=v.toString()});V.addEventListener("click",()=>{$?Se():(p++,k())});
